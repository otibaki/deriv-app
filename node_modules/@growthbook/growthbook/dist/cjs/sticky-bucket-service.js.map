{"version":3,"file":"sticky-bucket-service.js","names":["StickyBucketService","constructor","opts","prefix","getAllAssignments","attributes","docs","Promise","all","Object","entries","map","attributeName","attributeValue","getAssignments","forEach","doc","key","getKey","LocalStorageStickyBucketService","localStorage","globalThis","e","raw","getItem","data","JSON","parse","assignments","saveAssignments","setItem","stringify","ExpressCookieStickyBucketService","req","res","cookieAttributes","maxAge","cookies","str","cookie","encodeURIComponent","BrowserCookieStickyBucketService","jsCookie","expires","get","set","RedisStickyBucketService","redis","keys","mget","then","values","_attributeName","_attributeValue"],"sources":["../../src/sticky-bucket-service.ts"],"sourcesContent":["import {\n  LocalStorageCompat,\n  StickyAssignmentsDocument,\n  StickyAttributeKey,\n} from \"./types/growthbook\";\n\nexport interface CookieAttributes {\n  expires?: number | Date | undefined;\n  path?: string | undefined;\n  domain?: string | undefined;\n  secure?: boolean | undefined;\n  sameSite?: \"strict\" | \"Strict\" | \"lax\" | \"Lax\" | \"none\" | \"None\" | undefined;\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  [property: string]: any;\n}\nexport interface JsCookiesCompat<T = string> {\n  set(\n    name: string,\n    value: string | T,\n    options?: CookieAttributes\n  ): string | undefined;\n  get(name: string): string | T | undefined;\n  get(): { [key: string]: string };\n  remove(name: string, options?: CookieAttributes): void;\n}\n\nexport interface IORedisCompat {\n  mget(...keys: string[]): Promise<string[]>;\n  set(key: string, value: string): Promise<string>;\n}\n\nexport interface RequestCompat {\n  cookies: Record<string, string>;\n  [key: string]: unknown;\n}\nexport interface ResponseCompat {\n  cookie(\n    name: string,\n    value: string,\n    options?: CookieAttributes\n  ): ResponseCompat;\n  [key: string]: unknown;\n}\n\n/**\n * Responsible for reading and writing documents which describe sticky bucket assignments.\n */\nexport abstract class StickyBucketService {\n  protected prefix: string;\n\n  constructor(opts?: { prefix?: string }) {\n    opts = opts || {};\n    this.prefix = opts.prefix || \"\";\n  }\n\n  abstract getAssignments(\n    attributeName: string,\n    attributeValue: string\n  ): Promise<StickyAssignmentsDocument | null>;\n\n  abstract saveAssignments(doc: StickyAssignmentsDocument): Promise<unknown>;\n\n  /**\n   * The SDK calls getAllAssignments to populate sticky buckets. This in turn will\n   * typically loop through individual getAssignments calls. However, some StickyBucketService\n   * instances (i.e. Redis) will instead perform a multi-query inside getAllAssignments instead.\n   */\n  async getAllAssignments(\n    attributes: Record<string, string>\n  ): Promise<Record<StickyAttributeKey, StickyAssignmentsDocument>> {\n    const docs: Record<string, StickyAssignmentsDocument> = {};\n    (\n      await Promise.all(\n        Object.entries(attributes).map(([attributeName, attributeValue]) =>\n          this.getAssignments(attributeName, attributeValue)\n        )\n      )\n    ).forEach((doc) => {\n      if (doc) {\n        const key = `${doc.attributeName}||${doc.attributeValue}`;\n        docs[key] = doc;\n      }\n    });\n    return docs;\n  }\n\n  getKey(attributeName: string, attributeValue: string): string {\n    return `${this.prefix}${attributeName}||${attributeValue}`;\n  }\n}\n\nexport class LocalStorageStickyBucketService extends StickyBucketService {\n  private localStorage: LocalStorageCompat | undefined;\n  constructor(opts?: { prefix?: string; localStorage?: LocalStorageCompat }) {\n    opts = opts || {};\n    super();\n    this.prefix = opts.prefix || \"gbStickyBuckets__\";\n    try {\n      this.localStorage = opts.localStorage || globalThis.localStorage;\n    } catch (e) {\n      // Ignore localStorage errors\n    }\n  }\n  async getAssignments(attributeName: string, attributeValue: string) {\n    const key = this.getKey(attributeName, attributeValue);\n    let doc: StickyAssignmentsDocument | null = null;\n    if (!this.localStorage) return doc;\n    try {\n      const raw = (await this.localStorage.getItem(key)) || \"{}\";\n      const data = JSON.parse(raw);\n      if (data.attributeName && data.attributeValue && data.assignments) {\n        doc = data;\n      }\n    } catch (e) {\n      // Ignore localStorage errors\n    }\n    return doc;\n  }\n  async saveAssignments(doc: StickyAssignmentsDocument) {\n    const key = this.getKey(doc.attributeName, doc.attributeValue);\n    if (!this.localStorage) return;\n    try {\n      await this.localStorage.setItem(key, JSON.stringify(doc));\n    } catch (e) {\n      // Ignore localStorage errors\n    }\n  }\n}\n\nexport class ExpressCookieStickyBucketService extends StickyBucketService {\n  /**\n   * Intended to be used with cookieParser() middleware from npm: 'cookie-parser'.\n   * Assumes:\n   *  - reading a cookie is automatically decoded via decodeURIComponent() or similar\n   *  - writing a cookie name & value must be manually encoded via encodeURIComponent() or similar\n   *  - all cookie bodies are JSON encoded strings and are manually encoded/decoded\n   */\n  private req: RequestCompat;\n  private res: ResponseCompat;\n  private cookieAttributes: CookieAttributes;\n  constructor({\n    prefix = \"gbStickyBuckets__\",\n    req,\n    res,\n    cookieAttributes = { maxAge: 180 * 24 * 3600 * 1000 }, // 180 days\n  }: {\n    prefix?: string;\n    req: RequestCompat;\n    res: ResponseCompat;\n    cookieAttributes?: CookieAttributes;\n  }) {\n    super();\n    this.prefix = prefix;\n    this.req = req;\n    this.res = res;\n    this.cookieAttributes = cookieAttributes;\n  }\n  async getAssignments(attributeName: string, attributeValue: string) {\n    const key = this.getKey(attributeName, attributeValue);\n    let doc: StickyAssignmentsDocument | null = null;\n    if (!this.req) return doc;\n    try {\n      const raw = this.req.cookies[key] || \"{}\";\n      const data = JSON.parse(raw);\n      if (data.attributeName && data.attributeValue && data.assignments) {\n        doc = data;\n      }\n    } catch (e) {\n      // Ignore cookie errors\n    }\n    return doc;\n  }\n  async saveAssignments(doc: StickyAssignmentsDocument) {\n    const key = this.getKey(doc.attributeName, doc.attributeValue);\n    if (!this.res) return;\n    const str = JSON.stringify(doc);\n    this.res.cookie(\n      encodeURIComponent(key),\n      encodeURIComponent(str),\n      this.cookieAttributes\n    );\n  }\n}\n\nexport class BrowserCookieStickyBucketService extends StickyBucketService {\n  /**\n   * Intended to be used with npm: 'js-cookie'.\n   * Assumes:\n   *  - reading a cookie is automatically decoded via decodeURIComponent() or similar\n   *  - writing a cookie name & value is automatically encoded via encodeURIComponent() or similar\n   *  - all cookie bodies are JSON encoded strings and are manually encoded/decoded\n   */\n  private jsCookie: JsCookiesCompat;\n  private cookieAttributes: CookieAttributes;\n  constructor({\n    prefix = \"gbStickyBuckets__\",\n    jsCookie,\n    cookieAttributes = { expires: 180 }, // 180 days\n  }: {\n    prefix?: string;\n    jsCookie: JsCookiesCompat;\n    cookieAttributes?: CookieAttributes;\n  }) {\n    super();\n    this.prefix = prefix;\n    this.jsCookie = jsCookie;\n    this.cookieAttributes = cookieAttributes;\n  }\n  async getAssignments(attributeName: string, attributeValue: string) {\n    const key = this.getKey(attributeName, attributeValue);\n    let doc: StickyAssignmentsDocument | null = null;\n    if (!this.jsCookie) return doc;\n    try {\n      const raw = this.jsCookie.get(key);\n      const data = JSON.parse(raw || \"{}\");\n      if (data.attributeName && data.attributeValue && data.assignments) {\n        doc = data;\n      }\n    } catch (e) {\n      // Ignore cookie errors\n    }\n    return doc;\n  }\n  async saveAssignments(doc: StickyAssignmentsDocument) {\n    const key = this.getKey(doc.attributeName, doc.attributeValue);\n    if (!this.jsCookie) return;\n    const str = JSON.stringify(doc);\n    this.jsCookie.set(key, str, this.cookieAttributes);\n  }\n}\n\nexport class RedisStickyBucketService extends StickyBucketService {\n  /** Intended to be used with npm: 'ioredis'. **/\n  private redis: IORedisCompat | undefined;\n  constructor({ redis }: { redis: IORedisCompat }) {\n    super();\n    this.redis = redis;\n  }\n  async getAllAssignments(\n    attributes: Record<string, string>\n  ): Promise<Record<StickyAttributeKey, StickyAssignmentsDocument>> {\n    const docs: Record<StickyAttributeKey, StickyAssignmentsDocument> = {};\n    const keys = Object.entries(\n      attributes\n    ).map(([attributeName, attributeValue]) =>\n      this.getKey(attributeName, attributeValue)\n    );\n    if (!this.redis) return docs;\n    await this.redis.mget(...keys).then((values) => {\n      values.forEach((raw) => {\n        try {\n          const data = JSON.parse(raw || \"{}\");\n          if (data.attributeName && data.attributeValue && data.assignments) {\n            const key = `${data.attributeName}||${data.attributeValue}`;\n            docs[key] = data;\n          }\n        } catch (e) {\n          // ignore redis doc parse errors\n        }\n      });\n    });\n    return docs;\n  }\n  async getAssignments(_attributeName: string, _attributeValue: string) {\n    // not implemented\n    return null;\n  }\n  async saveAssignments(doc: StickyAssignmentsDocument) {\n    const key = this.getKey(doc.attributeName, doc.attributeValue);\n    if (!this.redis) return;\n    await this.redis.set(key, JSON.stringify(doc));\n  }\n}\n"],"mappings":"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"}